---
# Минимальный деплой node-exporter через Docker Compose.
# Запуск из каталога ansible: ansible-playbook -i inventory.ini deploy_node-exporter.yml

- name: Deploy node-exporter
  hosts: all
  become: true
  gather_facts: true
  vars:
    ansible_port: "{{ ssh_current_port }}"

  tasks:
    - name: Get remote user home directory
      command: echo $HOME
      register: remote_user_home
      changed_when: false
      become: false

    - name: Set node-exporter paths (in user home)
      set_fact:
        node_exporter_home: "{{ remote_user_home.stdout }}/node-exporter"
        compose_file: "{{ remote_user_home.stdout }}/node-exporter/node-exporter.yml"

    - name: Check Docker Compose
      command: docker compose version
      register: docker_compose_check
      changed_when: false
      failed_when: false

    - name: Install Docker (and Compose plugin) if missing
      block:
        - name: Install Docker via official script
          raw: "curl -fsSL https://get.docker.com | sh"
          changed_when: true
        - name: Ensure Docker is started
          service:
            name: docker
            state: started
            enabled: true
        - name: Wait for Docker daemon to be ready
          command: docker info
          register: docker_ready
          until: docker_ready.rc == 0
          retries: 12
          delay: 5
          changed_when: false
      when: docker_compose_check.rc != 0

    - name: Create node-exporter directory
      file:
        path: "{{ node_exporter_home }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Deploy node-exporter.yml (hostname from inventory)
      template:
        src: "{{ playbook_dir }}/templates/node-exporter.yml.j2"
        dest: "{{ compose_file }}"
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Ensure Docker daemon is running
      service:
        name: docker
        state: started
        enabled: true

    - name: Add {{ ansible_user }} to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: Wait for Docker daemon to be ready
      command: docker info
      register: docker_ready
      until: docker_ready.rc == 0
      retries: 12
      delay: 5
      changed_when: false

    - name: Run node-exporter container (recreate)
      shell: docker compose -f "{{ compose_file }}" up -d --force-recreate
      args:
        chdir: "{{ node_exporter_home }}"
      register: compose_run
      changed_when: true

    - name: Wait for node-exporter to listen on 9100
      wait_for:
        port: 9100
        host: 127.0.0.1
        delay: 2
        timeout: 10

    - name: Check node-exporter on 9100 returns response
      uri:
        url: http://127.0.0.1:9100/metrics
        return_content: true
        status_code: 200
      register: metrics_check
      failed_when: metrics_check.status != 200 or (metrics_check.content | length) == 0
