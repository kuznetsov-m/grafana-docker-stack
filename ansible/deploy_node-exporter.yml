---
# Минимальный деплой node-exporter через Docker Compose.
# Запуск из каталога ansible: ansible-playbook -i inventory.ini deploy_node-exporter.yml

- name: Deploy node-exporter
  hosts: all
  become: true
  gather_facts: true
  vars:
    ansible_port: "{{ ssh_current_port }}"

  tasks:
    - name: Get remote user home directory
      command: echo $HOME
      register: remote_user_home
      changed_when: false
      become: false

    - name: Set node-exporter paths (in user home)
      set_fact:
        node_exporter_home: "{{ remote_user_home.stdout }}/node-exporter"
        compose_file: "{{ remote_user_home.stdout }}/node-exporter/node-exporter.yml"

    # #region agent log
    - name: Check Docker Compose plugin (docker compose) as remote user
      shell: bash -lc 'docker compose version'
      register: docker_compose_check
      changed_when: false
      failed_when: false
      become: false

    - name: Check standalone docker-compose as remote user
      shell: bash -lc 'docker-compose --version'
      register: docker_compose_standalone_check
      changed_when: false
      failed_when: false
      become: false

    - name: Diagnostic — which docker and PATH (remote, login shell)
      shell: bash -lc 'echo PATH=$PATH; which docker || true; id; groups'
      register: diag_path
      changed_when: false
      become: false

    - name: Set docker_available and compose_cmd from checks
      set_fact:
        docker_available: "{{ docker_compose_check.rc == 0 or docker_compose_standalone_check.rc == 0 }}"
        compose_cmd: "{{ 'docker compose' if docker_compose_check.rc == 0 else 'docker-compose' }}"

    - name: Show docker_compose_check.rc
      debug:
        msg: "docker_compose_check.rc = {{ docker_compose_check.rc }}"

    - name: Show docker_compose_check stdout/stderr
      debug:
        msg:
          - "stdout: {{ docker_compose_check.stdout | default('') | trim }}"
          - "stderr: {{ docker_compose_check.stderr | default('') | trim }}"
          - "diag_path: {{ diag_path.stdout | default('') | trim }}"
      when: diag_path is defined

    - name: Append debug log (NDJSON)
      lineinfile:
        path: /Users/kuznetsov1024/Documents/projects/grafana-docker-stack/.cursor/debug-f8df65.log
        line: "{{ _debug_line }}"
        create: true
      vars:
        _debug_line: "{{ _debug_payload | to_json }}"
        _debug_payload:
          sessionId: "f8df65"
          hypothesisId: "diagnostic"
          message: "docker compose check + PATH/id"
          data:
            rc: "{{ docker_compose_check.rc }}"
            stdout: "{{ (docker_compose_check.stdout | default(''))[:500] }}"
            stderr: "{{ (docker_compose_check.stderr | default(''))[:500] }}"
            which_docker_and_path: "{{ (diag_path.stdout | default(''))[:500] if diag_path is defined else '' }}"
          timestamp: "{{ (ansible_date_time.epoch | int) * 1000 }}"
      delegate_to: localhost
      become: false
    # #endregion

    - name: Install Docker (and Compose plugin) if missing
      block:
        - name: Install Docker via official script
          raw: "curl -fsSL https://get.docker.com | sh"
          changed_when: true
        - name: Ensure Docker is started
          service:
            name: docker
            state: started
            enabled: true
        - name: Wait for Docker daemon to be ready
          command: docker info
          register: docker_ready
          until: docker_ready.rc == 0
          retries: 12
          delay: 5
          changed_when: false
      when: not docker_available

    - name: Create node-exporter directory
      file:
        path: "{{ node_exporter_home }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Deploy node-exporter.yml (hostname from inventory)
      template:
        src: "{{ playbook_dir }}/templates/node-exporter.yml.j2"
        dest: "{{ compose_file }}"
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Ensure Docker daemon is running
      service:
        name: docker
        state: started
        enabled: true

    - name: Add {{ ansible_user }} to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: Wait for Docker daemon to be ready
      command: docker info
      register: docker_ready
      until: docker_ready.rc == 0
      retries: 12
      delay: 5
      changed_when: false

    - name: Run node-exporter container (recreate)
      shell: "{{ compose_cmd }} -f \"{{ compose_file }}\" up -d --force-recreate"
      args:
        chdir: "{{ node_exporter_home }}"
      register: compose_run
      changed_when: true

    - name: Wait for node-exporter to listen on 9100
      wait_for:
        port: 9100
        host: 127.0.0.1
        delay: 2
        timeout: 10

    - name: Check node-exporter on 9100 returns response
      uri:
        url: http://127.0.0.1:9100/metrics
        return_content: true
        status_code: 200
      register: metrics_check
      failed_when: metrics_check.status != 200 or (metrics_check.content | length) == 0
